<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ascalon Capital - Fee Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .brand-gradient-text { background: linear-gradient(90deg, #3b82f6, #2563eb); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .input-group { display: flex; align-items: center; }
        
        /* Corrected input group styling for left/right addons */
        .input-group-text { display: inline-flex; align-items: center; padding: 0 0.75rem; background-color: #e5e7eb; border: 1px solid #d1d5db; color: #4b5563; font-size: 0.875rem; height: 42px; }
        .input-group-text-left { border-right: 0; border-radius: 0.375rem 0 0 0.375rem; }
        .input-group-text-right { border-left: 0; border-radius: 0 0.375rem 0.375rem 0; }
        
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        
        .modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(17, 24, 39, 0.6); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; z-index: 50; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-backdrop.active { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s ease; max-height: 90vh; overflow-y: auto;}
        .modal-backdrop.active .modal-content { transform: scale(1); }

        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2563eb; }
        input:checked + .slider:before { transform: translateX(22px); }
    </style>
</head>
<body class="antialiased text-gray-800">

    <button id="openSettingsBtn" class="fixed bottom-5 right-5 bg-white p-3 rounded-full shadow-lg hover:bg-gray-100 transition focus:outline-none focus:ring-2 focus:ring-blue-500 z-40" title="Admin Settings">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
    </button>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl">
        <header class="flex items-center justify-between mb-8">
            <div class="flex items-center space-x-4">
                <img src="" alt="Ascalon Capital Logo" class="h-12 w-12"><!-- Placeholder for your base64 logo -->
                <div><h1 class="text-2xl font-bold text-gray-900">Ascalon Capital</h1><p class="text-md text-gray-600">Prospect Fee Calculator</p></div>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-6 border-b pb-3">
                    <h2 class="text-xl font-bold brand-gradient-text">Client Assumptions</h2>
                    <div class="flex items-center">
                        <span class="text-sm font-medium text-gray-700 mr-3">Manual Fee</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="feeModeToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="text-sm font-medium text-gray-700 ml-3">Tiered</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div>
                        <label for="addressableFUA" class="block text-sm font-medium text-gray-700 mb-1">Addressable FUA (On Platform)</label>
                        <div class="input-group">
                            <span class="input-group-text input-group-text-left">$</span>
                            <input type="text" id="addressableFUA" value="300,000,000" inputmode="numeric" class="w-full p-2 border border-gray-300 rounded-r-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        </div>
                    </div>
                    <div>
                        <label for="growthAssumption" class="block text-sm font-medium text-gray-700 mb-1">Growth Assumption p.a.</label>
                        <div class="input-group">
                            <input type="number" id="growthAssumption" value="10" class="w-full p-2 border border-gray-300 rounded-l-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <span class="input-group-text input-group-text-right">%</span>
                        </div>
                    </div>
                    <div>
                        <label for="conversionAssumption" class="block text-sm font-medium text-gray-700 mb-1">2 yr Conversion Assumption</label>
                        <div class="input-group">
                            <select id="conversionAssumption" class="w-full p-2 border border-gray-300 rounded-l-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" style="height: 42px;">
                                <option value="10">10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option><option value="50">50</option><option value="60" selected>60</option><option value="70">70</option><option value="80">80</option><option value="90">90</option><option value="100">100</option>
                            </select>
                            <span class="input-group-text input-group-text-right">%</span>
                        </div>
                    </div>
                    <div id="manualBaseFeeContainer">
                        <label for="manualBaseFee" class="block text-sm font-medium text-gray-700 mb-1">Manual Base Fee</label>
                        <div class="input-group">
                            <input type="number" id="manualBaseFee" step="0.01" value="0.10" class="w-full p-2 border border-gray-300 rounded-l-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <span class="input-group-text input-group-text-right">%</span>
                        </div>
                    </div>

                    <!-- ACE Section with Toggle -->
                    <div class="md:col-span-2 border-t pt-6">
                        <div class="flex items-center justify-between mb-4">
                             <h3 class="text-lg font-semibold text-gray-800">ACE Revenue</h3>
                             <div class="flex items-center">
                                <span class="text-sm font-medium text-gray-700 mr-3">Exclude</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="includeAceToggle" checked>
                                    <span class="slider"></span>
                                </label>
                                <span class="text-sm font-medium text-gray-700 ml-3">Include</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                            <div id="aceFeeContainer">
                                <label for="aceFee" class="block text-sm font-medium text-gray-700 mb-1">ACE Fee</label>
                                <div class="input-group">
                                    <input type="number" id="aceFee" step="0.01" value="0.38" class="w-full p-2 border border-gray-300 rounded-l-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                    <span class="input-group-text input-group-text-right">%</span>
                                </div>
                            </div>
                            <div id="aceWeightContainer">
                                <label for="aceWeight" class="block text-sm font-medium text-gray-700 mb-1">ACE Weight</label>
                                <div class="input-group">
                                    <input type="number" id="aceWeight" value="10" class="w-full p-2 border border-gray-300 rounded-l-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                    <span class="input-group-text input-group-text-right">%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                     <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 border-t pt-6">
                        <div>
                            <label for="minRevenue" class="block text-sm font-medium text-gray-700 mb-1">Min Revenue</label>
                             <div class="input-group">
                                <span class="input-group-text input-group-text-left">$</span>
                                <input type="text" id="minRevenue" value="300,000" inputmode="numeric" class="w-full p-2 border border-gray-300 rounded-r-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            </div>
                        </div>
                        <div>
                            <label for="targetRevenue" class="block text-sm font-medium text-gray-700 mb-1">Target Revenue</label>
                             <div class="input-group">
                                <span class="input-group-text input-group-text-left">$</span>
                                <input type="text" id="targetRevenue" value="500,000" inputmode="numeric" class="w-full p-2 border border-gray-300 rounded-r-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Outputs -->
            <div class="lg:col-span-1 bg-white p-6 sm:p-8 rounded-2xl shadow-lg flex flex-col">
                <h2 class="text-xl font-bold mb-6 border-b pb-3 brand-gradient-text">Calculated Results</h2>
                <div class="space-y-5 flex-grow">
                    <div class="flex justify-between items-center"><span class="text-gray-600">Min Fee:</span><span id="minFee" class="font-bold text-lg text-gray-800">0.00%</span></div>
                    <div class="flex justify-between items-center"><span class="text-gray-600">Target Fee:</span><span id="targetFee" class="font-bold text-lg text-gray-800">0.00%</span></div>
                    <hr class="my-4">
                    <div class="flex justify-between items-center" title="The blended base fee rate based on the current FUA and tiered structure">
                        <span class="text-gray-600">Effective Base Fee:</span>
                        <span id="effectiveBaseFee" class="font-bold text-lg text-gray-800">0.00%</span>
                    </div>
                    <div class="flex justify-between items-center"><span class="text-gray-600">Base Revenue:</span><span id="baseRevenue" class="font-bold text-lg text-gray-800">$0.00</span></div>
                    <div class="flex justify-between items-center"><span class="text-gray-600">ACE Revenue:</span><span id="aceRevenue" class="font-bold text-lg text-gray-800">$0.00</span></div>
                </div>
                <div class="mt-6 pt-6 border-t-2 border-dashed">
                     <div id="warningMessage" class="hidden p-3 mb-4 text-sm text-red-800 rounded-lg bg-red-50 text-center" role="alert">
                        <span id="warningMessageText" class="font-medium">Approval required from ELT</span>
                    </div>
                    <div class="bg-gray-100 rounded-lg p-4 text-center">
                        <p class="text-sm font-medium text-gray-600 uppercase tracking-wider">Total Revenue</p>
                        <p id="totalRevenue" class="text-4xl font-extrabold text-blue-600 transition-colors duration-300">$0.00</p>
                    </div>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="lg:col-span-3 bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                    <h2 class="text-xl font-bold brand-gradient-text">Goal Seeking: Required Base Fee</h2>
                    <div class="flex items-center space-x-3">
                        <span class="text-sm font-medium text-gray-700">Include ACE Revenue Contribution</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="aceToggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div>
                    <canvas id="feeChart"></canvas>
                </div>
            </div>
            
            <!-- Guidance Table -->
            <div class="lg:col-span-3 bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                 <h2 class="text-xl font-bold mb-4 brand-gradient-text">Conversion Assumption Guidance</h2>
                 <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-gray-600">
                        <thead class="bg-gray-50 text-xs text-gray-700 uppercase">
                            <tr>
                                <th scope="col" class="px-6 py-3 rounded-l-lg">Scenario</th>
                                <th scope="col" class="px-6 py-3 rounded-r-lg text-right">Guidance %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-white border-b"><td class="px-6 py-4 font-medium text-gray-900">Single Platform, Model Portfolios and Single Ownership structure</td><td class="px-6 py-4 text-right font-semibold">70%</td></tr>
                            <tr class="bg-white border-b"><td class="px-6 py-4 font-medium text-gray-900">Multi Platform, Model Portfolios and Single Ownership Structure</td><td class="px-6 py-4 text-right font-semibold">60%</td></tr>
                            <tr class="bg-white border-b"><td class="px-6 py-4 font-medium text-gray-900">Multi Platform, No Model Portfolios, Co-Op Model</td><td class="px-6 py-4 text-right font-semibold">50%</td></tr>
                             <tr class="bg-white"><td class="px-6 py-4 font-medium text-gray-900">Multi Platform, No Model Portfolios, Co-Op Model</td><td class="px-6 py-4 text-right font-semibold">40%</td></tr>
                        </tbody>
                    </table>
                 </div>
            </div>
        </main>
    </div>

    <!-- START: Admin Modals -->
    <div id="passwordModal" class="modal-backdrop"><div class="modal-content">
        <h3 class="text-lg font-bold text-center text-gray-800 mb-1">Admin Access</h3>
        <p class="text-sm text-center text-gray-500 mb-4">Enter the password to access settings.</p>
        <div class="space-y-4">
            <input type="password" id="passwordInput" placeholder="Password" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
            <p id="passwordError" class="text-red-600 text-sm text-center hidden">Incorrect password. Please try again.</p>
            <button id="loginBtn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition">Unlock</button>
        </div>
    </div></div>

    <div id="settingsModal" class="modal-backdrop"><div class="modal-content">
        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Admin Settings</h3>
        <div class="space-y-6">
            <div>
                <h4 class="font-semibold text-gray-700 mb-2">Security</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 p-4 border rounded-lg">
                    <div>
                        <label for="settingNewPassword" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                        <input type="password" id="settingNewPassword" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="settingConfirmPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                        <input type="password" id="settingConfirmPassword" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <p id="passwordUpdateError" class="sm:col-span-2 text-red-600 text-sm hidden">Passwords do not match.</p>
                    <p id="passwordUpdateSuccess" class="sm:col-span-2 text-green-600 text-sm hidden">Password updated successfully.</p>
                </div>
            </div>
            
            <div>
                <h4 class="font-semibold text-gray-700 mb-2">Calculator & Chart Settings</h4>
                <div class="p-4 border rounded-lg space-y-4">
                    <div>
                        <label for="settingChartTarget" class="block text-sm font-medium text-gray-700 mb-1">Goal-Seeking Chart Target</label>
                        <select id="settingChartTarget" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="minRevenue">Min Revenue</option>
                            <option value="targetRevenue" selected>Target Revenue</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Select which revenue figure the goal-seeking chart should solve for.</p>
                    </div>
                    <div>
                        <label for="settingGrowthYears" class="block text-sm font-medium text-gray-700 mb-1">Growth Compounding Years</label>
                        <input type="number" id="settingGrowthYears" class="w-full p-2 border border-gray-300 rounded-md">
                        <p class="text-xs text-gray-500 mt-1">Used in ACE Revenue calc: (1 + Growth)^Years</p>
                    </div>
                </div>
            </div>

            <div>
                <h4 class="font-semibold text-gray-700 mb-2">Default Tiered Fee Structure</h4>
                <div class="space-y-3 p-4 border rounded-lg">
                    <div class="grid grid-cols-2 gap-4 items-end">
                        <div>
                            <label class="block text-xs font-medium text-gray-600">Tier 1: FUA up to ($)</label>
                            <input type="text" id="tier1-fua" inputmode="numeric" class="w-full p-2 border border-gray-300 rounded-md text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">Fee (%)</label>
                            <input type="number" step="0.01" id="tier1-fee" class="w-full p-2 border border-gray-300 rounded-md text-sm">
                        </div>
                    </div>
                     <div class="grid grid-cols-2 gap-4 items-end">
                        <div>
                            <label class="block text-xs font-medium text-gray-600">Tier 2: FUA up to ($)</label>
                            <input type="text" id="tier2-fua" inputmode="numeric" class="w-full p-2 border border-gray-300 rounded-md text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">Fee (%)</label>
                            <input type="number" step="0.01" id="tier2-fee" class="w-full p-2 border border-gray-300 rounded-md text-sm">
                        </div>
                    </div>
                      <div class="grid grid-cols-2 gap-4 items-end">
                        <div>
                            <label class="block text-xs font-medium text-gray-600">Tier 3: FUA above prev.</label>
                             <input type="text" disabled value="And above" class="w-full p-2 border bg-gray-100 border-gray-300 rounded-md text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">Fee (%)</label>
                            <input type="number" step="0.01" id="tier3-fee" class="w-full p-2 border border-gray-300 rounded-md text-sm">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-6 flex flex-col sm:flex-row-reverse gap-3">
            <button id="saveSettingsBtn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition">Save Changes</button>
            <button id="resetSettingsBtn" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-md hover:bg-gray-300 transition">Reset to Defaults</button>
        </div>
    </div></div>
    <!-- END: Admin Modals -->

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const defaultConfig = {
            password: "admin",
            warningThreshold: 200000,
            warningMessage: "Approval required from ELT",
            growthCompoundingYears: 2,
            chartTarget: 'targetRevenue',
            feeMode: 'tiered', // 'tiered' or 'manual'
            includeACE: true,
            manualBaseFee: 0.001,
            feeTiers: [
                { fuaUpTo: 50_000_000, fee: 0.12 },
                { fuaUpTo: 250_000_000, fee: 0.10 },
                { fuaUpTo: Infinity, fee: 0.08 }
            ]
        };
        let config = { ...defaultConfig };
        let feeChartInstance = null;

        const DOMElements = {
            inputs: {
                addressableFUA: document.getElementById('addressableFUA'), growthAssumption: document.getElementById('growthAssumption'),
                conversionAssumption: document.getElementById('conversionAssumption'), aceFee: document.getElementById('aceFee'),
                aceWeight: document.getElementById('aceWeight'), minRevenue: document.getElementById('minRevenue'),
                targetRevenue: document.getElementById('targetRevenue'),
                manualBaseFee: document.getElementById('manualBaseFee'),
            },
            containers: {
                manualBaseFee: document.getElementById('manualBaseFeeContainer'),
                aceFee: document.getElementById('aceFeeContainer'),
                aceWeight: document.getElementById('aceWeightContainer'),
            },
            toggles: {
                feeMode: document.getElementById('feeModeToggle'),
                includeAce: document.getElementById('includeAceToggle'),
            },
            outputs: {
                minFee: document.getElementById('minFee'), targetFee: document.getElementById('targetFee'),
                baseRevenue: document.getElementById('baseRevenue'), aceRevenue: document.getElementById('aceRevenue'),
                totalRevenue: document.getElementById('totalRevenue'), effectiveBaseFee: document.getElementById('effectiveBaseFee'),
            },
            warnings: { message: document.getElementById('warningMessage'), text: document.getElementById('warningMessageText'), },
            chart: { canvas: document.getElementById('feeChart'), aceToggle: document.getElementById('aceToggle'), },
            admin: {
                openBtn: document.getElementById('openSettingsBtn'),
                password: {
                    modal: document.getElementById('passwordModal'), input: document.getElementById('passwordInput'), error: document.getElementById('passwordError'),
                    loginBtn: document.getElementById('loginBtn'), newPass: document.getElementById('settingNewPassword'),
                    confirmPass: document.getElementById('settingConfirmPassword'), updateError: document.getElementById('passwordUpdateError'),
                    updateSuccess: document.getElementById('passwordUpdateSuccess'),
                },
                settings: {
                    modal: document.getElementById('settingsModal'), saveBtn: document.getElementById('saveSettingsBtn'), resetBtn: document.getElementById('resetSettingsBtn'),
                    chartTarget: document.getElementById('settingChartTarget'), growthYears: document.getElementById('settingGrowthYears'),
                    tier1FUA: document.getElementById('tier1-fua'), tier1Fee: document.getElementById('tier1-fee'),
                    tier2FUA: document.getElementById('tier2-fua'), tier2Fee: document.getElementById('tier2-fee'),
                    tier3Fee: document.getElementById('tier3-fee'),
                }
            }
        };

        const currencyInputs = [DOMElements.inputs.addressableFUA, DOMElements.inputs.minRevenue, DOMElements.inputs.targetRevenue, DOMElements.admin.settings.tier1FUA, DOMElements.admin.settings.tier2FUA];
        
        const formatCurrency = (v) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(v);
        const formatPercent = (v) => (v * 100).toFixed(3) + '%';
        const cleanNumberString = (s) => String(s).replace(/[^0-9.]/g, '');
        const formatNumberWithCommas = (s) => {
            const parts = cleanNumberString(s).split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return parts.join('.');
        }

        function calculateRequiredBaseFeePercent(fua, targetRevenue, includeACE) {
            const { b4, b5, b7, b8 } = getParsedInputs();
            if (fua === 0 || b5 === 0) return 0;
            let aceRevenueContribution = 0;
            if (includeACE) {
                const denominator = b5 * (fua * Math.pow(1 + b4, config.growthCompoundingYears));
                aceRevenueContribution = denominator * b8 * b7;
            }
            const requiredBaseRevenue = targetRevenue - aceRevenueContribution;
            const requiredEffectiveBaseFee = requiredBaseRevenue / (fua * b5);
            return requiredEffectiveBaseFee < 0 ? 0 : requiredEffectiveBaseFee;
        }
        
        function updateChart() {
            if (!feeChartInstance) return;
            const includeACE = DOMElements.chart.aceToggle.checked;
            const revenueTargetValue = parseFloat(cleanNumberString(DOMElements.inputs[config.chartTarget].value)) || 0;
            const fuaPoints = [50_000_000, 100_000_000, 250_000_000, 500_000_000, 750_000_000, 1_000_000_000];
            const requiredFeeData = fuaPoints.map(fua => calculateRequiredBaseFeePercent(fua, revenueTargetValue, includeACE));
            feeChartInstance.data.labels = fuaPoints.map(l => `$${(l/1_000_000).toFixed(0)}M`);
            feeChartInstance.data.datasets = [{
                label: `Required Base Fee % to hit ${formatCurrency(revenueTargetValue)}`,
                data: requiredFeeData,
                borderColor: includeACE ? 'rgb(34, 197, 94)' : 'rgb(59, 130, 246)',
                backgroundColor: includeACE ? 'rgba(34, 197, 94, 0.5)' : 'rgba(59, 130, 246, 0.5)',
                fill: false, tension: 0.1
            }];
            feeChartInstance.update();
        }

        function calculateTieredBaseRevenue(fua) {
            let revenue = 0;
            let remainingFUA = fua;
            let lastTierBoundary = 0;
            for (const tier of config.feeTiers) {
                if (remainingFUA <= 0) break;
                const tierBracketSize = tier.fuaUpTo - lastTierBoundary;
                const fuaInThisTier = Math.min(remainingFUA, tierBracketSize);
                revenue += fuaInThisTier * (tier.fee / 100);
                remainingFUA -= fuaInThisTier;
                lastTierBoundary = tier.fuaUpTo;
            }
            return revenue;
        }

        function getParsedInputs() {
            return {
                b3: parseFloat(cleanNumberString(DOMElements.inputs.addressableFUA.value)) || 0,
                b4: (parseFloat(DOMElements.inputs.growthAssumption.value) || 0) / 100,
                b5: (parseFloat(DOMElements.inputs.conversionAssumption.value) || 0) / 100,
                b7: (parseFloat(DOMElements.inputs.aceFee.value) || 0) / 100,
                b8: (parseFloat(DOMElements.inputs.aceWeight.value) || 0) / 100,
                b9: parseFloat(cleanNumberString(DOMElements.inputs.minRevenue.value)) || 0,
                b10: parseFloat(cleanNumberString(DOMElements.inputs.targetRevenue.value)) || 0,
                manualBaseFee: (parseFloat(DOMElements.inputs.manualBaseFee.value) || 0) / 100,
            };
        }

        function performCalculations(values) {
            const denominator = values.b5 * (values.b3 * Math.pow(1 + values.b4, config.growthCompoundingYears));
            
            let baseRevenue;
            if (config.feeMode === 'manual') {
                baseRevenue = values.b3 * values.b5 * values.manualBaseFee;
            } else { // tiered
                baseRevenue = calculateTieredBaseRevenue(values.b3) * values.b5;
            }

            const aceRevenue = config.includeACE ? (denominator * values.b8 * values.b7) : 0;
            const totalRevenue = baseRevenue + aceRevenue;
            return { minFee: denominator === 0 ? 0 : values.b9 / denominator, targetFee: denominator === 0 ? 0 : values.b10 / denominator, baseRevenue, aceRevenue, totalRevenue };
        }

        function calculateAndDisplay() {
            const values = getParsedInputs();
            const results = performCalculations(values);
            DOMElements.outputs.minFee.textContent = formatPercent(results.minFee);
            DOMElements.outputs.targetFee.textContent = formatPercent(results.targetFee);
            DOMElements.outputs.baseRevenue.textContent = formatCurrency(results.baseRevenue);
            DOMElements.outputs.aceRevenue.textContent = formatCurrency(results.aceRevenue);
            DOMElements.outputs.totalRevenue.textContent = formatCurrency(results.totalRevenue);
            
            let effectiveBaseFeeDecimal = 0;
            if (values.b3 > 0 && values.b5 > 0) {
                effectiveBaseFeeDecimal = results.baseRevenue / (values.b3 * values.b5);
            }
            DOMElements.outputs.effectiveBaseFee.textContent = formatPercent(effectiveBaseFeeDecimal);

            DOMElements.warnings.text.textContent = config.warningMessage;
            if (results.totalRevenue < config.warningThreshold && results.totalRevenue > 0) {
                DOMElements.warnings.message.classList.remove('hidden');
                DOMElements.outputs.totalRevenue.classList.replace('text-blue-600', 'text-red-600');
            } else {
                DOMElements.warnings.message.classList.add('hidden');
                DOMElements.outputs.totalRevenue.classList.replace('text-red-600', 'text-blue-600');
            }
            updateChart();
        }

        function saveSettings() {
            const newPass = DOMElements.admin.password.newPass.value;
            const confirmPass = DOMElements.admin.password.confirmPass.value;
            DOMElements.admin.password.updateError.classList.add('hidden');
            DOMElements.admin.password.updateSuccess.classList.add('hidden');
            if (newPass || confirmPass) {
                if (newPass === confirmPass && newPass !== "") {
                    config.password = newPass;
                    DOMElements.admin.password.updateSuccess.classList.remove('hidden');
                    setTimeout(() => DOMElements.admin.password.updateSuccess.classList.add('hidden'), 3000);
                    DOMElements.admin.password.newPass.value = '';
                    DOMElements.admin.password.confirmPass.value = '';
                } else {
                    DOMElements.admin.password.updateError.classList.remove('hidden'); return;
                }
            }
            config.chartTarget = DOMElements.admin.settings.chartTarget.value;
            config.growthCompoundingYears = parseFloat(DOMElements.admin.settings.growthYears.value) || defaultConfig.growthCompoundingYears;
            config.feeTiers = [
                { fuaUpTo: parseFloat(cleanNumberString(DOMElements.admin.settings.tier1FUA.value)) || 0, fee: parseFloat(DOMElements.admin.settings.tier1Fee.value) || 0 },
                { fuaUpTo: parseFloat(cleanNumberString(DOMElements.admin.settings.tier2FUA.value)) || 0, fee: parseFloat(DOMElements.admin.settings.tier2Fee.value) || 0 },
                { fuaUpTo: Infinity, fee: parseFloat(DOMElements.admin.settings.tier3Fee.value) || 0 }
            ];
            localStorage.setItem('ascalonFeeCalcSettings', JSON.stringify(config));
            calculateAndDisplay();
            closeModal(DOMElements.admin.settings.modal);
        }

        function loadSettings() {
            const saved = localStorage.getItem('ascalonFeeCalcSettings');
            if (saved) {
                const parsed = JSON.parse(saved);
                config = { ...defaultConfig, ...parsed, feeTiers: parsed.feeTiers || defaultConfig.feeTiers };
            }
            DOMElements.admin.settings.chartTarget.value = config.chartTarget;
            DOMElements.admin.settings.growthYears.value = config.growthCompoundingYears;
            DOMElements.admin.settings.tier1FUA.value = formatNumberWithCommas(config.feeTiers[0].fuaUpTo);
            DOMElements.admin.settings.tier1Fee.value = config.feeTiers[0].fee;
            DOMElements.admin.settings.tier2FUA.value = formatNumberWithCommas(config.feeTiers[1].fuaUpTo);
            DOMElements.admin.settings.tier2Fee.value = config.feeTiers[1].fee;
            DOMElements.admin.settings.tier3Fee.value = config.feeTiers[2].fee;
            DOMElements.inputs.manualBaseFee.value = config.manualBaseFee * 100;
            setFeeModeUI(config.feeMode);
            setAceUI(config.includeACE);
        }
        
        /**
         * MODIFIED: Controls the UI for the Manual/Tiered fee mode.
         */
        function setFeeModeUI(mode) {
            const manualInput = DOMElements.inputs.manualBaseFee;
            const container = DOMElements.containers.manualBaseFee;

            if (mode === 'manual') {
                DOMElements.toggles.feeMode.checked = false;
                container.classList.remove('opacity-50');
                manualInput.disabled = false;
                manualInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
            } else { // tiered
                DOMElements.toggles.feeMode.checked = true;
                container.classList.add('opacity-50');
                manualInput.disabled = true;
                manualInput.classList.add('bg-gray-100', 'cursor-not-allowed');
            }
        }
        
        function setAceUI(enabled) {
            DOMElements.toggles.includeAce.checked = enabled;
            const containers = [DOMElements.containers.aceFee, DOMElements.containers.aceWeight];
            const inputs = [DOMElements.inputs.aceFee, DOMElements.inputs.aceWeight];

            if (enabled) {
                containers.forEach(c => c.classList.remove('opacity-50'));
                inputs.forEach(i => {
                    i.disabled = false;
                    i.classList.remove('bg-gray-100', 'cursor-not-allowed');
                });
            } else {
                containers.forEach(c => c.classList.add('opacity-50'));
                inputs.forEach(i => {
                    i.disabled = true;
                    i.classList.add('bg-gray-100', 'cursor-not-allowed');
                });
            }
        }

        function handleLoginAttempt() {
            if (DOMElements.admin.password.input.value === config.password) {
                DOMElements.admin.password.input.value = '';
                DOMElements.admin.password.error.classList.add('hidden');
                closeModal(DOMElements.admin.password.modal);
                openModal(DOMElements.admin.settings.modal);
            } else {
                DOMElements.admin.password.error.classList.remove('hidden');
            }
        }
        
        function setupChart() {
            const ctx = DOMElements.chart.canvas.getContext('2d');
            feeChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { title: { display: true, text: 'Addressable FUA' } },
                        y: { title: { display: true, text: 'Required Base Fee %' },
                             ticks: { callback: (value) => formatPercent(value) }
                        }
                    },
                    plugins: { tooltip: { callbacks: { label: (context) => `Required Fee: ${formatPercent(context.raw)}` } } }
                }
            });
        }

        // --- Event Listeners & Initialisation ---
        const closeModal = (m) => m.classList.remove('active');
        const openModal = (m) => m.classList.add('active');
        Object.values(DOMElements.inputs).forEach(input => input.addEventListener(input.tagName.toLowerCase() === 'select' ? 'change' : 'input', calculateAndDisplay));
        currencyInputs.forEach(input => input.addEventListener('input', (e) => {
            const val = e.target.value; const pos = e.target.selectionStart; const len = val.length;
            e.target.value = formatNumberWithCommas(val);
            e.target.setSelectionRange(pos + (e.target.value.length - len), pos + (e.target.value.length - len));
        }));
        
        DOMElements.toggles.feeMode.addEventListener('change', (e) => {
            config.feeMode = e.target.checked ? 'tiered' : 'manual';
            if(config.feeMode === 'manual') {
                config.manualBaseFee = (parseFloat(DOMElements.inputs.manualBaseFee.value) || 0) / 100;
            }
            localStorage.setItem('ascalonFeeCalcSettings', JSON.stringify(config));
            setFeeModeUI(config.feeMode);
            calculateAndDisplay();
        });
        
        DOMElements.toggles.includeAce.addEventListener('change', (e) => {
            config.includeACE = e.target.checked;
            localStorage.setItem('ascalonFeeCalcSettings', JSON.stringify(config));
            setAceUI(config.includeACE);
            calculateAndDisplay();
        });

        DOMElements.chart.aceToggle.addEventListener('change', updateChart);
        DOMElements.admin.openBtn.addEventListener('click', () => openModal(DOMElements.admin.password.modal));
        DOMElements.admin.password.loginBtn.addEventListener('click', handleLoginAttempt);
        DOMElements.admin.password.input.addEventListener('keyup', (e) => e.key === 'Enter' && handleLoginAttempt());
        DOMElements.admin.settings.saveBtn.addEventListener('click', saveSettings);
        DOMElements.admin.settings.resetBtn.addEventListener('click', () => { if (confirm("Reset settings to default?")) { localStorage.removeItem('ascalonFeeCalcSettings'); config = { ...defaultConfig }; loadSettings(); saveSettings(); } });
        [DOMElements.admin.password.modal, DOMElements.admin.settings.modal].forEach(modal => modal.addEventListener('click', (e) => e.target === modal && closeModal(modal)));

        loadSettings();
        setupChart();
        calculateAndDisplay();
    });
    </script>
</body>
</html>
